<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>27번 도구 - 엑셀 업로드 (셀 X 안정화 v1)</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --panel:#ffffff;
      --ink:#1f2937;
      --muted:#6b7280;
      --line:#e5e7eb;
      --accent:#2563eb;
      --danger:#ef4444;
      --dangerSoft:#ffe4e6;
      --shadow: 0 6px 18px rgba(0,0,0,.08);
      --radius: 14px;
      --btn: 44px;          /* X 버튼 크기 */
      --btnHit: 54px;       /* 실제 클릭영역 */
      --rowH: 54px;         /* 행 높이 */
      --font: system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans KR","Apple SD Gothic Neo",sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--ink);
      background:var(--bg);
    }

    /* 상단 바 */
    .topbar{
      position:sticky; top:0; z-index:50;
      background:linear-gradient(180deg,#ffffff 0%, #fbfbfe 100%);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1400px; margin:0 auto; padding:14px 16px;}
    h1{
      margin:0 0 8px 0;
      font-size:18px;
      letter-spacing:-0.3px;
    }
    .sub{
      margin:0;
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
    }

    /* 컨트롤 */
    .controls{
      display:flex; flex-wrap:wrap; gap:10px;
      align-items:center;
      margin-top:12px;
    }
    .controls .group{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      padding:10px;
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }
    .btn{
      border:1px solid var(--line);
      background:#fff;
      color:var(--ink);
      padding:10px 12px;
      border-radius:12px;
      font-size:13px;
      cursor:pointer;
      user-select:none;
      transition:transform .05s ease, border-color .15s ease, box-shadow .15s ease;
    }
    .btn:hover{border-color:#cbd5e1; box-shadow:0 4px 12px rgba(0,0,0,.07)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{
      background:var(--accent);
      border-color:var(--accent);
      color:#fff;
    }
    .btn.danger{
      background:#fff;
      border-color:#fecaca;
      color:#b91c1c;
    }
    .file{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      font-size:13px;
      color:var(--muted);
    }
    input[type="file"]{
      border:1px dashed #cbd5e1;
      background:#fff;
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      max-width:360px;
    }
    .status{
      display:flex; gap:12px; flex-wrap:wrap;
      font-size:12px; color:var(--muted);
    }
    .pill{
      background:#fff;
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
      box-shadow:0 4px 10px rgba(0,0,0,.05);
      white-space:nowrap;
    }
    .pill b{color:var(--ink)}
    .keys{
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      font-size:11px;
      color:#374151;
    }

    /* 테이블 영역: 세로 스크롤만 */
    .main{
      max-width:1400px;
      margin:0 auto;
      padding:12px 16px 10px 16px;
    }
    .tableBox{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .tableScroll{
      /* 세로 스크롤만 */
      overflow-y:auto;
      overflow-x:hidden;
      max-height: calc(100vh - 320px);
    }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      table-layout:fixed;
      font-size:13px;
    }
    thead th{
      position:sticky; top:0; z-index:10;
      background:#f8fafc;
      border-bottom:1px solid var(--line);
      color:#111827;
      font-weight:700;
      text-align:left;
      padding:10px 10px;
      height:44px;
      white-space:nowrap;
    }
    tbody td{
      border-bottom:1px solid #f1f5f9;
      padding:0;
      vertical-align:top;
      height:var(--rowH);
      background:#fff;
    }
    tbody tr:hover td{background:#fbfdff}

    /* 셀 내부(값 + 큰 X 버튼) */
    .cell{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:8px 10px;
      min-height:var(--rowH);
    }
    .val{
      min-width:0;
      flex:1 1 auto;
      line-height:1.25;
      word-break:break-word;
      overflow:hidden;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
    }
    .val.mono{
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      font-size:12px;
      letter-spacing:0.1px;
    }
    .val.muted{color:var(--muted)}
    .xbtnWrap{
      flex:0 0 auto;
      width:var(--btnHit);
      height:var(--btnHit);
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .xbtn{
      width:var(--btn);
      height:var(--btn);
      border-radius:14px;
      border:2px solid #fca5a5;
      background:var(--dangerSoft);
      color:#7f1d1d;
      font-weight:900;
      font-size:18px;
      cursor:pointer;
      box-shadow:0 6px 12px rgba(239,68,68,.15);
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      transition:transform .05s ease, filter .15s ease;
    }
    .xbtn:hover{filter:brightness(1.02)}
    .xbtn:active{transform:translateY(1px)}
    .xmark{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:11px;
      font-weight:800;
      color:#991b1b;
      background:#ffe4e6;
      border:1px solid #fecaca;
      border-radius:999px;
      padding:2px 8px;
      margin-left:8px;
      white-space:nowrap;
    }

    /* 컬럼 너비 (가로 스크롤 없이 “줄바꿈”으로 처리) */
    col.pub{width:140px}
    col.title{width:330px}
    col.kort{width:220px}
    col.sub{width:260px}
    col.kors{width:220px}
    col.isbn{width:150px}
    col.price{width:110px}
    col.cur{width:110px}
    col.date{width:130px}
    col.pages{width:110px}

    /* 하단 로그: 화면 아래 고정 */
    .logbar{
      position:sticky;
      bottom:0;
      z-index:40;
      background:linear-gradient(180deg, rgba(246,247,251,0) 0%, rgba(246,247,251,.75) 30%, rgba(246,247,251,1) 100%);
      padding:10px 0 14px 0;
      margin-top:10px;
    }
    .logBox{
      max-width:1400px;
      margin:0 auto;
      padding:0 16px;
    }
    .logPanel{
      background:#0b1220;
      color:#e5e7eb;
      border:1px solid rgba(255,255,255,.10);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .logHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .logHead .title{
      font-size:13px;
      font-weight:800;
    }
    .logBtns{display:flex; gap:8px; flex-wrap:wrap}
    .logBtn{
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.06);
      color:#e5e7eb;
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      font-size:12px;
    }
    .logBtn:hover{background:rgba(255,255,255,.10)}
    .logBody{
      max-height:170px;
      overflow:auto;
      padding:10px 12px;
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      font-size:11px;
      line-height:1.35;
      white-space:pre-wrap;
      word-break:break-word;
    }

    /* 경고/안내 */
    .note{
      margin-top:10px;
      padding:10px 12px;
      background:#fff;
      border:1px solid var(--line);
      border-radius:var(--radius);
      color:var(--muted);
      font-size:12px;
      box-shadow:var(--shadow);
    }
    .note b{color:var(--ink)}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="wrap">
      <h1>27번 도구 – 엑셀 업로드 (셀 X 안정화 v1)</h1>
      <p class="sub">
        셀마다 X만 존재 · PASS 없음 · 행 X 없음 · 정렬/재배치 없음 · ANCHOR+HASH로 행 섞임 원천 차단 · 로그 자동 저장(localStorage)
      </p>

      <div class="controls">
        <div class="group">
          <div class="file">
            <label><b>파일 선택</b></label>
            <input id="file" type="file" accept=".csv,.tsv,.txt" />
            <span id="fileName">(미선택)</span>
          </div>
          <button class="btn primary" id="btnUpload">업로드(추가/합치기)</button>
          <button class="btn danger" id="btnResetDB">DB 초기화</button>
          <button class="btn" id="btnExportDB">DB 내보내기(JSON)</button>
        </div>

        <div class="group status">
          <span class="pill">상태: <b id="st">대기</b></span>
          <span class="pill">총 행: <b id="rowCount">0</b></span>
          <span class="pill">총 셀 X: <b id="xCount">0</b></span>
          <span class="pill">DB키: <span class="keys" id="dbKey"></span></span>
          <span class="pill">LOG키: <span class="keys" id="logKey"></span></span>
        </div>
      </div>

      <div class="note">
        지원: <b>CSV/TSV</b> (첫 줄 헤더 권장) · 컬럼 하드고정:
        <b>Publisher, Title, Sub Title, KOR_TITLE, KOR_SUBTITLE, ISBN, Price, Currency, Pub Date, Pages</b><br/>
        렌더 고정: <b>ANCHOR = 파일명|row:n</b> 기반 (업로드 후 위치 고정) · KOR_TITLE은 Title 오른쪽, KOR_SUBTITLE은 Sub Title 오른쪽.
      </div>
    </div>
  </div>

  <div class="main">
    <div class="tableBox">
      <div class="tableScroll" id="tableScroll">
        <table id="tbl">
          <colgroup>
            <col class="pub" />
            <col class="title" />
            <col class="kort" />
            <col class="sub" />
            <col class="kors" />
            <col class="isbn" />
            <col class="price" />
            <col class="cur" />
            <col class="date" />
            <col class="pages" />
          </colgroup>
          <thead>
            <tr>
              <th>Publisher</th>
              <th>Title</th>
              <th>KOR_TITLE</th>
              <th>Sub Title</th>
              <th>KOR_SUBTITLE</th>
              <th>ISBN</th>
              <th>Price</th>
              <th>Currency</th>
              <th>Pub Date</th>
              <th>Pages</th>
            </tr>
          </thead>
          <tbody id="tb"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="logbar">
    <div class="logBox">
      <div class="logPanel">
        <div class="logHead">
          <div class="title">자동 로그 (셀 X 클릭 시 즉시 누적/저장)</div>
          <div class="logBtns">
            <button class="logBtn" id="btnCopyLog">로그 복사</button>
            <button class="logBtn" id="btnClearLog">로그 초기화</button>
          </div>
        </div>
        <div class="logBody" id="logBody"></div>
      </div>
    </div>
  </div>

<script>
(() => {
  // ====== 고정 컬럼 ======
  const COLS = [
    "Publisher","Title","KOR_TITLE","Sub Title","KOR_SUBTITLE",
    "ISBN","Price","Currency","Pub Date","Pages"
  ];

  // ====== localStorage 키 ======
  const DB_KEY  = "wic_xdb_v27";
  const LOG_KEY = "wic_xlog_v27";
  document.getElementById("dbKey").textContent = DB_KEY;
  document.getElementById("logKey").textContent = LOG_KEY;

  // ====== 상태 ======
  const el = (id) => document.getElementById(id);
  const st = el("st"), rowCount = el("rowCount"), xCount = el("xCount");
  const fileInput = el("file");
  const fileName = el("fileName");
  const tb = el("tb");
  const logBody = el("logBody");

  // ====== DB 구조 ======
  // db = { rows: { [anchor]: { anchor, hash, file, rowNo, cells: {col: value} } },
  //        xmarks: { [anchor+"|"+col]: { before, after, ts } } }
  let db = loadDB();
  let logs = loadLogs();

  // ====== 유틸 ======
  function nowStamp(){
    const d = new Date();
    const p = (n)=>String(n).padStart(2,"0");
    return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`;
  }
  function safeText(v){
    if (v === null || v === undefined) return "";
    return String(v).replace(/\u0000/g,"").trim();
  }

  // 간단 해시(FNV-1a)
  function fnv1a(str){
    let h = 0x811c9dc5;
    for (let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = (h + ((h<<1)+(h<<4)+(h<<7)+(h<<8)+(h<<24))) >>> 0;
    }
    return ("00000000"+h.toString(16)).slice(-8);
  }

  // CSV/TSV 파서(간단, 따옴표 대응)
  function parseDelimited(text, delim){
    const rows = [];
    let cur = "", inQ = false;
    let row = [];
    for (let i=0;i<text.length;i++){
      const ch = text[i];
      const next = text[i+1];

      if (inQ){
        if (ch === '"' && next === '"'){ cur += '"'; i++; continue; }
        if (ch === '"'){ inQ = false; continue; }
        cur += ch;
      } else {
        if (ch === '"'){ inQ = true; continue; }
        if (ch === "\r") continue;
        if (ch === "\n"){
          row.push(cur);
          rows.push(row);
          row = []; cur = "";
          continue;
        }
        if (ch === delim){
          row.push(cur);
          cur = "";
          continue;
        }
        cur += ch;
      }
    }
    // last
    if (cur.length>0 || row.length>0){
      row.push(cur);
      rows.push(row);
    }
    return rows;
  }

  function detectDelimiter(text){
    // 탭 우선
    const firstLine = text.split(/\r?\n/)[0] || "";
    const tabs = (firstLine.match(/\t/g)||[]).length;
    const commas = (firstLine.match(/,/g)||[]).length;
    return tabs >= commas ? "\t" : ",";
  }

  function normalizeHeader(h){
    return safeText(h).toLowerCase().replace(/\s+/g," ").trim();
  }

  function mapRowToFixed(header, values){
    // header 매핑(없으면 순서 매핑)
    const out = {};
    if (header && header.length){
      const idx = {};
      header.forEach((h,i)=>{ idx[normalizeHeader(h)] = i; });
      for (const c of COLS){
        const key = normalizeHeader(c);
        const i = idx[key];
        out[c] = i === undefined ? "" : safeText(values[i] ?? "");
      }
    } else {
      // 순서대로 채움
      for (let i=0;i<COLS.length;i++){
        out[COLS[i]] = safeText(values[i] ?? "");
      }
    }
    return out;
  }

  function loadDB(){
    try{
      const raw = localStorage.getItem(DB_KEY);
      if (!raw) return { rows:{}, xmarks:{} };
      const parsed = JSON.parse(raw);
      if (!parsed.rows) parsed.rows = {};
      if (!parsed.xmarks) parsed.xmarks = {};
      return parsed;
    } catch(e){
      return { rows:{}, xmarks:{} };
    }
  }
  function saveDB(){
    localStorage.setItem(DB_KEY, JSON.stringify(db));
  }

  function loadLogs(){
    try{
      const raw = localStorage.getItem(LOG_KEY);
      if (!raw) return [];
      const parsed = JSON.parse(raw);
      return Array.isArray(parsed) ? parsed : [];
    } catch(e){
      return [];
    }
  }
  function saveLogs(){
    localStorage.setItem(LOG_KEY, JSON.stringify(logs));
  }

  function pushLog(line){
    logs.push(line);
    // 너무 길어지면 뒤에서 2000줄만 유지
    if (logs.length > 2000) logs = logs.slice(-2000);
    saveLogs();
    renderLog();
  }

  function renderLog(){
    logBody.textContent = logs.join("\n");
    // 최신 로그가 보이도록 아래로
    logBody.scrollTop = logBody.scrollHeight;
  }

  function updateStatus(){
    const rows = Object.keys(db.rows).length;
    const x = Object.keys(db.xmarks).length;
    rowCount.textContent = String(rows);
    xCount.textContent = String(x);
  }

  // ====== 렌더(엑셀 표) ======
  function cellView(anchor, col, value){
    const key = anchor + "|" + col;
    const xed = !!db.xmarks[key];

    const td = document.createElement("td");
    const box = document.createElement("div");
    box.className = "cell";

    const val = document.createElement("div");
    const isMono = ["ISBN","Price","Pages","Pub Date","Currency"].includes(col);
    val.className = "val" + (isMono ? " mono" : "");
    if (!safeText(value)) {
      val.classList.add("muted");
      val.textContent = "(빈값)";
    } else {
      val.textContent = safeText(value);
    }

    if (xed){
      const tag = document.createElement("span");
      tag.className = "xmark";
      tag.textContent = "X처리";
      val.appendChild(tag);
    }

    const btnWrap = document.createElement("div");
    btnWrap.className = "xbtnWrap";
    const btn = document.createElement("button");
    btn.className = "xbtn";
    btn.type = "button";
    btn.textContent = "X";
    btn.title = "이 셀을 X 처리";

    btn.addEventListener("click", () => {
      toggleX(anchor, col);
    });

    btnWrap.appendChild(btn);
    box.appendChild(val);
    box.appendChild(btnWrap);
    td.appendChild(box);
    return td;
  }

  function renderTable(){
    tb.innerHTML = "";
    // ANCHOR 기준으로 안정적 정렬(파일명 -> rowNo)
    const list = Object.values(db.rows).slice().sort((a,b)=>{
      if (a.file !== b.file) return a.file.localeCompare(b.file);
      return (a.rowNo||0) - (b.rowNo||0);
    });

    for (const r of list){
      const tr = document.createElement("tr");
      for (const col of COLS){
        tr.appendChild(cellView(r.anchor, col, (r.cells||{})[col] ?? ""));
      }
      tb.appendChild(tr);
    }
    updateStatus();
  }

  // ====== X 토글(셀 단위) ======
  function toggleX(anchor, col){
    const row = db.rows[anchor];
    if (!row) return;

    const key = anchor + "|" + col;
    const before = safeText((row.cells||{})[col] ?? "");
    const ts = nowStamp();

    if (db.xmarks[key]){
      // X 해제(원래 값 복원)
      const prev = db.xmarks[key];
      row.cells[col] = prev.before ?? "";
      delete db.xmarks[key];
      saveDB();
      pushLog(`[${ts}] ${anchor} | ${col} | X 해제 → "${safeText(row.cells[col])}"`);
      renderTable();
      return;
    }

    // X 처리: 값은 빈칸으로 만들고, xmarks에 before 저장
    db.xmarks[key] = { before, after:"", ts };
    row.cells[col] = "";
    saveDB();
    pushLog(`[${ts}] ${anchor} | ${col} | "${before}" → ""`);
    renderTable();
  }

  // ====== 업로드(추가/합치기) ======
  async function readFileText(file){
    return await file.text();
  }

  function upsertRowsFromText(filename, text){
    const delim = detectDelimiter(text);
    const parsed = parseDelimited(text, delim);
    if (!parsed.length){
      st.textContent = "빈 파일";
      return { add:0, update:0, total:Object.keys(db.rows).length };
    }

    // 헤더 판단: 첫 줄에 고정 컬럼 중 2개 이상 포함하면 헤더로 간주
    const first = parsed[0].map(safeText);
    const firstNorm = first.map(normalizeHeader);
    const hits = COLS.reduce((acc,c)=> acc + (firstNorm.includes(normalizeHeader(c)) ? 1 : 0), 0);
    const hasHeader = hits >= 2;

    const header = hasHeader ? first : null;
    const start = hasHeader ? 1 : 0;

    let add=0, update=0;
    for (let i=start;i<parsed.length;i++){
      const rowNo = i+1; // "엑셀 row:n"처럼 보이게(헤더 포함 시 실제 행번호 느낌)
      const values = parsed[i];
      const cells = mapRowToFixed(header, values);

      // anchor 고정
      const anchor = `${filename}|row:${rowNo}`;
      const join = COLS.map(c=>safeText(cells[c]??"")).join("||");
      const hash = fnv1a(join);

      const exists = db.rows[anchor];
      if (!exists){
        db.rows[anchor] = { anchor, hash, file: filename, rowNo, cells };
        add++;
      } else {
        // 동일 anchor면 갱신(단, hash가 바뀐 경우만)
        if (exists.hash !== hash){
          db.rows[anchor] = { anchor, hash, file: filename, rowNo, cells };
          update++;
        }
      }
    }
    saveDB();
    return { add, update, total:Object.keys(db.rows).length };
  }

  // ====== 버튼 동작 ======
  fileInput.addEventListener("change", () => {
    const f = fileInput.files && fileInput.files[0];
    fileName.textContent = f ? f.name : "(미선택)";
  });

  el("btnUpload").addEventListener("click", async () => {
    const f = fileInput.files && fileInput.files[0];
    if (!f){
      st.textContent = "파일 선택 필요";
      return;
    }
    const ts = nowStamp();
    st.textContent = "업로드 중…";
    const text = await readFileText(f);

    const { add, update, total } = upsertRowsFromText(f.name, text);
    st.textContent = "업로드 완료";

    pushLog(`[${ts}] 업로드(추가/합치기): ${f.name} (추가 ${add}, 갱신 ${update}, 총 ${total})`);
    renderTable();
  });

  el("btnResetDB").addEventListener("click", () => {
    db = { rows:{}, xmarks:{} };
    saveDB();
    const ts = nowStamp();
    pushLog(`[${ts}] DB 초기화`);
    st.textContent = "DB 초기화";
    renderTable();
  });

  el("btnExportDB").addEventListener("click", () => {
    const data = JSON.stringify(db, null, 2);
    const blob = new Blob([data], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "wic_xdb_v27.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  el("btnCopyLog").addEventListener("click", async () => {
    const text = logs.join("\n");
    try{
      await navigator.clipboard.writeText(text);
    } catch(e){
      // fallback
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
    }
  });

  el("btnClearLog").addEventListener("click", () => {
    logs = [];
    saveLogs();
    renderLog();
  });

  // ====== 초기 렌더 ======
  st.textContent = "로드 완료";
  renderTable();
  renderLog();
  updateStatus();
})();
</script>
</body>
</html>
