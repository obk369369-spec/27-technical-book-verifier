<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>27번 도구 – CSV 업로드 · 표준 컬럼 매핑 · X 자동검증 (v4)</title>
  <style>
    :root{
      --bg:#ffffff;
      --panel:#f7f7f9;
      --panel2:#ffffff;
      --txt:#111111;
      --muted:#555555;
      --line:#d9d9de;
      --ok:#1a7f37;
      --bad:#d1242f;
      --warn:#b54708;
      --btn:#ffffff;
      --btnLine:#c9c9d3;
      --shadow:0 1px 6px rgba(0,0,0,.06);
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--txt); }
    header{ position:sticky; top:0; z-index:80; background:rgba(255,255,255,.96); border-bottom:1px solid var(--line); backdrop-filter:saturate(120%) blur(6px); }
    .wrap{ max-width:1200px; margin:0 auto; padding:12px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .titleBox{ flex:1; min-width:260px; padding:10px 12px; border:1px solid var(--line); border-radius:12px; background:var(--panel); box-shadow:var(--shadow); }
    .titleBox .t{ font-weight:800; font-size:14px; }
    .titleBox .s{ margin-top:4px; font-size:12px; color:var(--muted); line-height:1.35; }
    .btn{
      background:var(--btn); color:var(--txt); border:1px solid var(--btnLine);
      padding:10px 12px; border-radius:12px; cursor:pointer; font-size:13px;
      box-shadow:var(--shadow);
    }
    .btn:active{ transform:translateY(1px); }
    .btn.primary{ border-color:#2a79ff; }
    .btn.danger{ border-color:var(--bad); }
    .btn.ok{ border-color:var(--ok); }
    .btn.small{ padding:6px 10px; border-radius:10px; font-size:12px; }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }
    input[type="file"]{ display:none; }

    .kpis{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .kpi{ padding:6px 10px; border-radius:999px; background:#fff; border:1px solid var(--line); font-size:12px; color:var(--muted); box-shadow:var(--shadow); }
    .kpi b{ color:var(--txt); }

    .tabs{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .tab{
      padding:8px 10px; border-radius:999px; border:1px solid var(--line);
      background:#fff; font-size:12px; cursor:pointer; box-shadow:var(--shadow);
    }
    .tab.on{ border-color:#2a79ff; }

    main .wrap{ padding-top:10px; }
    .tableWrap{
      border:1px solid var(--line); border-radius:14px; overflow:hidden;
      background:#fff; box-shadow:var(--shadow);
    }
    table{ width:100%; border-collapse:separate; border-spacing:0; table-layout:fixed; }
    thead th{
      position:sticky; top:120px; z-index:20;
      background:#fff; color:var(--muted);
      border-bottom:1px solid var(--line);
      padding:10px 8px; font-size:12px; text-align:left;
      white-space:nowrap;
    }
    tbody td{
      border-bottom:1px solid var(--line);
      padding:8px; vertical-align:top; font-size:13px;
      word-break:break-word; overflow-wrap:anywhere;
      background:#fff;
    }
    tbody tr:nth-child(even) td{ background:#fcfcfd; }
    tbody tr:hover td{ background:#f3f7ff; }

    .gridCell{
      display:flex; gap:8px; align-items:flex-start;
    }
    .xbtn{
      flex:0 0 auto;
      display:inline-flex; align-items:center; justify-content:center;
      width:30px; height:26px; border-radius:10px;
      border:1px solid var(--line); background:#fff; cursor:pointer;
      font-weight:900; user-select:none;
    }
    .xbtn.on{ border-color:var(--bad); color:var(--bad); background:#fff5f5; }
    .xbtn.off{ border-color:rgba(26,127,55,.35); color:var(--ok); background:#f3fff6; }

    .mono{ font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 8px; border-radius:999px; border:1px solid var(--line);
      background:#fff; font-size:12px; color:var(--muted);
    }
    .badgeBad{ color:var(--bad); font-weight:800; }
    .badgeWarn{ color:var(--warn); font-weight:800; }
    .badgeOk{ color:var(--ok); font-weight:800; }

    .colPub{ width:100px; }
    .colTitle{ width:240px; }
    .colSub{ width:210px; }
    .colKor{ width:170px; }
    .colISBN{ width:140px; }
    .colPrice{ width:90px; }
    .colCur{ width:80px; }
    .colDate{ width:110px; }
    .colPages{ width:80px; }
    .colAnchor{ width:220px; }

    details{ background:#fff; border:1px solid var(--line); border-radius:14px; padding:10px; box-shadow:var(--shadow); }
    details summary{ cursor:pointer; color:var(--muted); font-size:13px; }
    pre{ margin:8px 0 0; max-height:220px; overflow:auto; background:#fbfbfd; padding:10px; border-radius:12px; border:1px solid var(--line); font-size:12px; }

    .footerBar{
      position:fixed; left:0; right:0; bottom:0; z-index:90;
      background:rgba(255,255,255,.96); border-top:1px solid var(--line);
      backdrop-filter:saturate(120%) blur(6px);
    }
    .footerInner{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .footerLeft{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    .modalBack{
      position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:120;
      padding:14px;
    }
    .modal{
      width:min(1020px, 100%); max-height:86vh; overflow:auto;
      background:#fff; border:1px solid var(--line); border-radius:16px; padding:12px;
      box-shadow:0 10px 30px rgba(0,0,0,.15);
    }
    .modal h3{ margin:0; font-size:14px; }
    .hint{ font-size:12px; color:var(--muted); margin-top:6px; line-height:1.35; }
    .list{ display:flex; flex-direction:column; gap:8px; margin-top:10px; }
    .item{ border:1px solid var(--line); border-radius:14px; padding:10px; background:#fff; }
    .itemTop{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .itemMeta{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .reason{ color:var(--muted); font-size:12px; margin-top:6px; }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    /* 모바일: 가로 스크롤 제거(카드 모드) */
    .cards{ display:none; }
    @media (max-width: 900px){
      thead th{ top:172px; }
      .tableWrap{ overflow:visible; }
      table{ display:none; }
      .cards{ display:block; }
      .card{
        border:1px solid var(--line); border-radius:14px; background:#fff; box-shadow:var(--shadow);
        padding:10px; margin-bottom:10px;
      }
      .cardTop{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
      .kv{ margin-top:8px; display:grid; grid-template-columns: 100px 1fr; gap:6px 10px; }
      .k{ color:var(--muted); font-size:12px; }
      .v{ font-size:13px; word-break:break-word; }
    }
    .spacer{ height:140px; }
  </style>
</head>
<body>

<header>
  <div class="wrap">
    <div class="row">
      <div class="titleBox">
        <div class="t">27번 도구 – CSV 업로드 · 표준 컬럼 매핑 · X 자동검증 (v4)</div>
        <div class="s">
          ① 원본컬럼(발행사별) ② 표준컬럼(LOCK_STANDARD_COLS) ③ 매핑표(원본→표준) ④ UI 레이아웃(LOCK_UI) = <b>상수로 완전 잠금</b><br/>
          사용자는 <b>업로드 → 리스트 확인 → 복사</b>만 수행. 사진/로그 수동 입력 최소화.
        </div>
      </div>

      <label class="btn primary" for="fileInput">업로드(추가)</label>
      <input id="fileInput" type="file" accept=".csv,text/csv" multiple />

      <button class="btn danger" id="btnResetDB">DB 초기화</button>
      <button class="btn" id="btnClearLog">로그 초기화</button>

      <button class="btn ok" id="btnAutoFix">자동 수정</button>
      <button class="btn" id="btnShowX">X 리스트</button>
      <button class="btn" id="btnShowW">경고 리스트</button>
    </div>

    <div class="row" style="margin-top:10px;">
      <div class="kpis">
        <span class="kpi">DB: <b id="kpiRows">0</b> rows</span>
        <span class="kpi">X(열림): <b id="kpiXOpen">0</b></span>
        <span class="kpi">경고: <b id="kpiWarn">0</b></span>
        <span class="kpi">Last: <b id="kpiLast">-</b></span>
        <span class="kpi">정렬: Pub Date ↑ (이 도구 전용)</span>
        <span class="kpi"><span class="badgeOk">행 섞임 방지</span> rowId=file|row|hash</span>
      </div>

      <div class="tabs" style="margin-left:auto;">
        <span class="tab on" id="tabTable">표</span>
        <span class="tab" id="tabLog">로그</span>
      </div>

      <button class="btn small" id="btnResort">정렬 재적용</button>
      <button class="btn small" id="btnRecalc">오류 재계산</button>
    </div>
  </div>
</header>

<main>
  <div class="wrap" id="viewTable">
    <div class="tableWrap" id="tableWrap">
      <table>
        <thead><tr id="hdr"></tr></thead>
        <tbody id="body"></tbody>
      </table>

      <div class="cards" id="cards"></div>
    </div>
    <div class="spacer"></div>
  </div>

  <div class="wrap" id="viewLog" style="display:none;">
    <details id="logBox" open>
      <summary>로그(복사 후 대화창 붙여넣기 가능)</summary>
      <div class="row" style="margin-top:8px;">
        <button class="btn small" id="btnCopyLog">로그 복사</button>
      </div>
      <pre id="log"></pre>
    </details>
    <div class="spacer"></div>
  </div>
</main>

<div class="footerBar">
  <div class="wrap">
    <div class="footerInner">
      <div class="footerLeft">
        <span class="pill"><b>X</b>는 “데이터 오류/필수 누락” (예: KOR 공란 포함)</span>
        <span class="pill"><b>경고</b>는 “UI/애매/주의”</span>
      </div>
      <div class="row" style="margin:0;">
        <button class="btn" id="btnCopyX">X 리스트 복사</button>
        <button class="btn" id="btnCopyW">경고 리스트 복사</button>
      </div>
    </div>
  </div>
</div>

<!-- X MODAL -->
<div class="modalBack" id="modalXBack">
  <div class="modal">
    <div class="row" style="margin-bottom:8px;">
      <h3 style="flex:1;">X 리스트 (도구 자동 산출)</h3>
      <button class="btn" id="btnCloseX">닫기</button>
    </div>
    <div class="row">
      <button class="btn small" id="btnResolveAllX">X 전체 “공란 유지로 해결”</button>
      <button class="btn small" id="btnClearResolvedX">X 해결표시 초기화</button>
      <button class="btn small" id="btnCopyXIn">X 리스트 복사</button>
    </div>
    <div class="hint">
      X는 “문제 목록”이고, 해결은 <b>옵션 버튼</b>으로만 처리한다. (사용자 텍스트 입력 유도 금지)<br/>
      예) KOR 공란 → “공란 유지(해결)”로 처리 가능(값 생성 없이, 작업 종료 가능).
    </div>
    <div class="list" id="xList"></div>
  </div>
</div>

<!-- WARN MODAL -->
<div class="modalBack" id="modalWBack">
  <div class="modal">
    <div class="row" style="margin-bottom:8px;">
      <h3 style="flex:1;">경고 리스트</h3>
      <button class="btn" id="btnCloseW">닫기</button>
    </div>
    <div class="row">
      <button class="btn small" id="btnCopyWIn">경고 리스트 복사</button>
    </div>
    <div class="hint">
      경고는 UI/애매/주의 사항이다. (X로 올릴지 말지는 도구가 규칙으로 결정한다)
    </div>
    <div class="list" id="wList"></div>
  </div>
</div>

<script>
/* ===========================
 *  0) 완전 잠금 상수(5가지 축)
 *  =========================== */
const LOCK_STANDARD_COLS = [
  "Publisher","Title","Sub Title","KOR_TITLE","KOR_SUBTITLE","ISBN","Price","Currency","Pub Date","Pages","_ANCHOR(file|row|id)"
];
const LOCK_UI = Object.freeze({
  theme: "LIGHT_ONLY",
  headerSticky: true,
  footerFixed: true,
  noBlackColors: true,
  preferNoHScroll: true,
});
const LOCK_X_RULES = Object.freeze({
  // 사용자 기준: KOR 공란은 X
  KOR_BLANK_IS_X: true,
  CURRENCY_REQUIRED: true,
  PRICE_REQUIRED: true,
  ISBN_13_REQUIRED: true,
});
const LOCK_PUBLISHERS = Object.freeze({
  Elsevier: {
    match: (name)=> /\(elsevier\)/i.test(name) || /elsevier/i.test(name),
    mapping: {
      "Title":"Title",
      "Sub Title":"",
      "KOR_TITLE":"",
      "KOR_SUBTITLE":"",
      "ISBN":"ISBN",
      "Price":"List Price (USD)",
      "Currency":"__CONST_USD__",
      "Pub Date":"Pub date",
      "Pages":"No of Pages"
    },
    rawHeadersAnyOf: [
      ["ISBN","Title","List Price (USD)","Pub date","No of Pages"]
    ]
  },
  Springer: {
    match: (name)=> /^springer-/i.test(name) || /springer/i.test(name),
    mapping: {
      "Title":"Title",
      "Sub Title":"Sub Title",
      "KOR_TITLE":"",
      "KOR_SUBTITLE":"",
      "ISBN":"ISBN",
      "Price":"Price EUR",
      "Currency":"__CONST_EUR__",
      "Pub Date":"Actual Publishing Date",
      "Pages":"No of Arabic Pages"
    },
    rawHeadersAnyOf: [
      ["ISBN","Title","Sub Title","No of Arabic Pages","Price EUR","Actual Publishing Date"]
    ]
  },
  Wiley: {
    match: (name)=> /wiley/i.test(name),
    mapping: {
      "Title":"Title",
      "Sub Title":"",
      "KOR_TITLE":"",
      "KOR_SUBTITLE":"",
      "ISBN":"ISBN13",
      "Price":"US$",
      "Currency":"__CONST_USD__",
      "Pub Date":"Pub Date",
      "Pages":"Pages"
    },
    rawHeadersAnyOf: [
      ["Title","Pub Date","Pages","ISBN13","US$"],
      ["ISBN13","Title","Pub Date","US$"]
    ]
  }
});

/* ===========================
 *  1) 저장 키
 *  =========================== */
const LS_DB   = "wic27_db_v4";
const LS_LOG  = "wic27_log_v4";
const LS_RES  = "wic27_resolutions_v4"; // issueKey -> resolution

let DB = loadJSON(LS_DB, []);
let logLines = loadJSON(LS_LOG, []);
let resolutions = loadJSON(LS_RES, {}); // { issueKey: "KEEP_BLANK" | "AUTO_CONVERT" | "IGNORE" }

/* ===========================
 *  2) 유틸
 *  =========================== */
function loadJSON(key, fallback){
  try{ const raw = localStorage.getItem(key); if(!raw) return fallback; return JSON.parse(raw); }
  catch(e){ return fallback; }
}
function saveJSON(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

function djb2(str){
  let h = 5381;
  for(let i=0;i<str.length;i++){ h = ((h<<5)+h) + str.charCodeAt(i); h = h >>> 0; }
  return ("00000000" + h.toString(16)).slice(-8);
}
function normBlank(v){ return (v==null) ? "" : String(v).trim(); }

function parseCSV(text){
  const rows = [];
  let i=0, cur="", inQ=false;
  const row=[];
  function pushCell(){ row.push(cur); cur=""; }
  function pushRow(){
    if(row.length===1 && row[0].trim()===""){ row.length=0; return; }
    rows.push(row.slice()); row.length=0;
  }
  while(i<text.length){
    const ch = text[i];
    if(inQ){
      if(ch === '"'){
        if(text[i+1] === '"'){ cur+='"'; i+=2; continue; }
        inQ=false; i++; continue;
      }
      cur += ch; i++; continue;
    }else{
      if(ch === '"'){ inQ=true; i++; continue; }
      if(ch === ','){ pushCell(); i++; continue; }
      if(ch === '\n'){ pushCell(); pushRow(); i++; continue; }
      if(ch === '\r'){ i++; continue; }
      cur += ch; i++; continue;
    }
  }
  pushCell(); pushRow();
  return rows;
}

function stripMoney(s){
  s = normBlank(s);
  if(!s) return "";
  s = s.replace(/[,\s]/g,"");
  s = s.replace(/^\$/,"");
  return s;
}
function toNumberOrBad(s){
  s = stripMoney(s);
  if(!s) return "";
  const n = Number(s);
  if(Number.isFinite(n)) return String(n);
  return "__BAD__";
}
function sciToIntStr(s){
  s = normBlank(s);
  if(!s) return "";
  const m = s.match(/^([0-9]+(?:\.[0-9]+)?)E\+([0-9]+)$/i);
  if(!m) return s;
  const base = m[1];
  const exp = parseInt(m[2],10);
  const parts = base.split(".");
  const intPart = parts[0];
  const fracPart = (parts[1]||"");
  const digits = (intPart + fracPart).replace(/^0+/,"") || "0";
  const zeros = exp - fracPart.length;
  if(zeros >= 0) return digits + "0".repeat(zeros);
  return s;
}
function normISBN(s){
  s = normBlank(s);
  if(!s) return "";
  if(/E\+/i.test(s)) s = sciToIntStr(s);
  const digits = s.replace(/[^0-9]/g,"");
  return digits || s;
}
const MONTH = {jan:1,feb:2,mar:3,apr:4,may:5,jun:6,jul:7,aug:8,sep:9,oct:10,nov:11,dec:12};
function pad2(n){ return (n<10?("0"+n):String(n)); }
function isValidDate(y,m,d){
  if(y<1900||y>2100) return false;
  if(m<1||m>12) return false;
  const dt = new Date(y, m-1, d);
  return dt.getFullYear()===y && (dt.getMonth()+1)===m && dt.getDate()===d;
}
function normDate(s){
  s = normBlank(s);
  if(!s) return "";
  let m = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
  if(m){
    const y=+m[1], mo=+m[2], d=+m[3];
    if(isValidDate(y,mo,d)) return `${y}-${pad2(mo)}-${pad2(d)}`;
    return "__BAD__";
  }
  m = s.match(/^(\d{1,2})-([A-Za-z]{3})-(\d{2}|\d{4})$/);
  if(m){
    const d=+m[1];
    const mo = MONTH[m[2].toLowerCase()];
    let y = +m[3];
    if(!mo) return "__BAD__";
    if(String(m[3]).length===2) y = 2000 + y;
    if(isValidDate(y,mo,d)) return `${y}-${pad2(mo)}-${pad2(d)}`;
    return "__BAD__";
  }
  return "__BAD__";
}
function normPages(s){
  s = normBlank(s);
  if(!s) return "";
  const t = s.replace(/[,\s]/g,"");
  if(/^\d+$/.test(t)) return t;
  return "__BAD__";
}

function fmtCell(v){
  if(v==="") return "(빈칸)";
  if(v==="__BAD__") return "(형식오류)";
  return v;
}

function detectPublisher(fileName){
  for(const key of Object.keys(LOCK_PUBLISHERS)){
    if(LOCK_PUBLISHERS[key].match(fileName)) return key;
  }
  const m = fileName.match(/\(([^)]+)\)/);
  if(m) return m[1].trim();
  return "Unknown";
}
function getMappingFor(fileName){
  const pub = detectPublisher(fileName);
  return (LOCK_PUBLISHERS[pub] && LOCK_PUBLISHERS[pub].mapping) ? LOCK_PUBLISHERS[pub].mapping : null;
}
function getCell(headers, rawRow, colName){
  const idx = headers.findIndex(h => h.trim() === colName.trim());
  if(idx<0) return "";
  return normBlank(rawRow[idx] ?? "");
}

function makeAnchor(fileName, rowIndex, outRow){
  const stable = `${fileName}|${rowIndex}|${outRow.Title||""}|${outRow.ISBN||""}`;
  const id = djb2(stable);
  const anchorStr = `${fileName} | ${rowIndex} | ${id}`;
  return { file:fileName, rowIndex, id, anchorStr, anchorKey:`${fileName}|${rowIndex}|${id}` };
}

/* ===========================
 *  3) 로그
 *  =========================== */
function log(event, payload){
  const now = new Date();
  const ts = now.toISOString().replace("T"," ").slice(0,19);
  const line = `[${ts}] ${event} :: ${JSON.stringify(payload)}`;
  logLines.push(line);
  if(logLines.length>900) logLines = logLines.slice(-900);
  saveJSON(LS_LOG, logLines);
  renderLog();
}
function renderLog(){
  document.getElementById("log").textContent = logLines.join("\n");
}

/* ===========================
 *  4) 표준화 row 생성
 *  =========================== */
function makeStandardRow({fileName,publisher,headers,rawRow,rowIndex,mapping}){
  const out = {};
  out["Publisher"] = publisher;

  function mapStd(std){
    const src = mapping ? mapping[std] : "";
    if(!src) return "";
    if(src === "__CONST_USD__") return "USD";
    if(src === "__CONST_EUR__") return "EUR";
    if(src === "__BLANK__") return "";
    return getCell(headers, rawRow, src);
  }

  out["Title"] = mapStd("Title");
  out["Sub Title"] = mapStd("Sub Title");
  out["KOR_TITLE"] = mapStd("KOR_TITLE");
  out["KOR_SUBTITLE"] = mapStd("KOR_SUBTITLE");

  out["ISBN"] = normISBN(mapStd("ISBN"));
  const priceNorm = toNumberOrBad(mapStd("Price"));
  out["Price"] = (priceNorm==="__BAD__") ? "__BAD__" : priceNorm;

  out["Currency"] = normBlank(mapStd("Currency"));
  out["Pub Date"] = normDate(mapStd("Pub Date"));
  out["Pages"] = normPages(mapStd("Pages"));

  const anc = makeAnchor(fileName, rowIndex, out);
  out["_ANCHOR(file|row|id)"] = anc.anchorStr;
  out.__anchor = {file:anc.file, rowIndex:anc.rowIndex, id:anc.id};
  out.__anchorKey = anc.anchorKey;

  return out;
}

/* ===========================
 *  5) 정렬
 *  =========================== */
function sortDB(){
  DB.sort((a,b)=>{
    const da = (a["Pub Date"] && a["Pub Date"]!=="__BAD__") ? a["Pub Date"] : "9999-99-99";
    const db = (b["Pub Date"] && b["Pub Date"]!=="__BAD__") ? b["Pub Date"] : "9999-99-99";
    if(da<db) return -1;
    if(da>db) return 1;
    return a.__anchorKey < b.__anchorKey ? -1 : 1;
  });
}

/* ===========================
 *  6) 이슈 엔진 (X + 경고)
 *  =========================== */
function issueKey(type, row, col, code){
  const a = row ? row[" _ANCHOR(file|row|id)"] : "";
  return `${type}|${row ? row.__anchorKey : "UI"}|${col || ""}|${code}`;
}
function getResolution(key){ return resolutions[key] || ""; }
function setResolution(key, val){ resolutions[key]=val; saveJSON(LS_RES, resolutions); }

function computeXandWarnings(){
  const X = [];
  const W = [];

  // UI 경고(가로 스크롤, 헤더 sticky)
  try{
    const wrap = document.getElementById("tableWrap");
    const hScroll = wrap.scrollWidth > wrap.clientWidth + 2;
    if(hScroll){
      W.push({
        no:0, type:"UI", code:"UI_HSCROLL",
        msg:"가로 스크롤이 발생함(피로 유발).",
        how:"HOW=모바일은 카드뷰(가로 스크롤 없음). 데스크톱은 열 폭을 더 줄이거나 Title 폭을 조정."
      });
    }
    const th = document.querySelector("thead th");
    if(th){
      const pos = getComputedStyle(th).position;
      if(pos !== "sticky"){
        W.push({
          no:0, type:"UI", code:"UI_HEADER_NOT_STICKY",
          msg:"헤더 sticky가 적용되지 않음(스크롤 시 필드가 사라짐).",
          how:"HOW=브라우저 캐시 강제 새로고침(Ctrl+F5) 후 재확인."
        });
      }
    }
  }catch(e){}

  // 데이터 X 규칙
  for(const row of DB){
    const rowId = row["_ANCHOR(file|row|id)"] || row[" _ANCHOR(file|row|id)"] || row["__ANCHOR"] || row.__anchorKey;

    // Title 필수
    if(!normBlank(row["Title"])){
      X.push(makeIssue("X","DATA","TITLE_BLANK","Title이 비어있음(필수).", row, "Title",
        `rowId=${rowId}`, "HOW=원본에 Title이 없는 경우만 공란 유지(해결)로 처리"));
    }

    // KOR 공란 = X (사용자 기준)
    if(LOCK_X_RULES.KOR_BLANK_IS_X){
      if(!normBlank(row["KOR_TITLE"])){
        X.push(makeIssue("X","DATA","KOR_TITLE_BLANK","KOR_TITLE이 비어있음(사용자 기준 X).", row, "KOR_TITLE",
          `rowId=${rowId}`, "HOW=공란 유지(해결) / 자동 변환(불가) / 무시(권장X)"));
      }
      if(!normBlank(row["KOR_SUBTITLE"])){
        X.push(makeIssue("X","DATA","KOR_SUBTITLE_BLANK","KOR_SUBTITLE이 비어있음(사용자 기준 X).", row, "KOR_SUBTITLE",
          `rowId=${rowId}`, "HOW=공란 유지(해결) / 자동 변환(불가) / 무시(권장X)"));
      }
    }else{
      // 공란 허용이면 경고로만
      if(!normBlank(row["KOR_TITLE"])){
        W.push(makeIssue("W","DATA","KOR_TITLE_BLANK","한글 타이틀이 비어있음(공란 허용이지만 확인 필요).", row, "KOR_TITLE",
          `rowId=${rowId}`, "HOW=(빈칸) 유지 / 번역은 다른 프로세스"));
      }
      if(!normBlank(row["KOR_SUBTITLE"])){
        W.push(makeIssue("W","DATA","KOR_SUBTITLE_BLANK","한글 부제가 비어있음(공란 허용이지만 확인 필요).", row, "KOR_SUBTITLE",
          `rowId=${rowId}`, "HOW=(빈칸) 유지 / 번역은 다른 프로세스"));
      }
    }

    // ISBN 13자리
    if(LOCK_X_RULES.ISBN_13_REQUIRED){
      const digits = normBlank(row["ISBN"]).replace(/[^0-9]/g,"");
      if(digits && digits.length !== 13){
        X.push(makeIssue("X","DATA","ISBN_BAD","ISBN이 13자리가 아님.", row, "ISBN",
          `rowId=${rowId}`, "HOW=자동 수정(과학표기/하이픈 제거) 후 재검증"));
      }
      if(!digits){
        X.push(makeIssue("X","DATA","ISBN_BLANK","ISBN이 비어있음(필수).", row, "ISBN",
          `rowId=${rowId}`, "HOW=원본에 ISBN이 없으면 공란 유지(해결)로 처리"));
      }
    }

    // Price 필수
    if(LOCK_X_RULES.PRICE_REQUIRED){
      const pr = normBlank(row["Price"]);
      if(!pr){
        X.push(makeIssue("X","DATA","PRICE_BLANK","Price가 비어있음(필수).", row, "Price",
          `rowId=${rowId}`, "HOW=원본에 없으면 공란 유지(해결) / 있으면 자동 수정"));
      }else if(pr==="__BAD__"){
        X.push(makeIssue("X","DATA","PRICE_BAD","Price 숫자 해석 불가.", row, "Price",
          `rowId=${rowId}`, "HOW=자동 수정(통화기호/쉼표 제거)"));
      }else{
        const n = Number(pr);
        if(Number.isFinite(n) && n===0){
          X.push(makeIssue("X","DATA","PRICE_ZERO","Price=0 (X).", row, "Price",
            `rowId=${rowId}`, "HOW=원본값 확인 필요"));
        }
      }
    }

    // Currency 필수
    if(LOCK_X_RULES.CURRENCY_REQUIRED){
      const cu = normBlank(row["Currency"]);
      if(!cu){
        X.push(makeIssue("X","DATA","CURR_EMPTY","Currency가 비어있음(필수).", row, "Currency",
          `rowId=${rowId}`, "HOW=발행사 상수(USD/EUR) 자동 입력 또는 원본 확인"));
      }
    }

    // Pub Date 형식
    const d = normBlank(row["Pub Date"]);
    if(d==="__BAD__"){
      X.push(makeIssue("X","DATA","DATE_BAD","Pub Date 형식 오류.", row, "Pub Date",
        `rowId=${rowId}`, "HOW=자동 수정(01-Feb-27 → 2027-02-01 등)"));
    }
    // Pages 숫자
    const pg = normBlank(row["Pages"]);
    if(pg==="__BAD__"){
      X.push(makeIssue("X","DATA","PAGES_BAD","Pages 숫자 해석 불가.", row, "Pages",
        `rowId=${rowId}`, "HOW=자동 수정(쉼표 제거/숫자만)"));
    }
  }

  // 해결(Resolution) 반영: 해결된 X는 “열림”에서 제외
  const XOpen = X.filter(it => !isResolved(it));
  return { X, XOpen, W };
}

function makeIssue(kind, type, code, msg, row, col, meta, how){
  const rowId = row ? (row["_ANCHOR(file|row|id)"] || row.__anchorKey) : "";
  const key = `${kind}|${row ? row.__anchorKey : "UI"}|${col||""}|${code}`;
  return { kind, type, code, msg, rowId, col: col||"", meta, how, key };
}
function isResolved(issue){
  const r = getResolution(issue.key);
  return r === "KEEP_BLANK" || r === "AUTO_CONVERT" || r === "IGNORE";
}

/* ===========================
 *  7) 자동 수정(안전한 변환만)
 *  =========================== */
function autoFix(){
  // 생성 금지: 원본이 있는 값만 정규화, 발행사 통화 상수는 허용
  let changed = 0;
  for(const row of DB){
    // ISBN
    const isbn = normBlank(row["ISBN"]);
    if(isbn){
      const n = normISBN(isbn);
      if(n !== isbn){ row["ISBN"]=n; changed++; }
    }
    // Price
    const pr = normBlank(row["Price"]);
    if(pr){
      const n = toNumberOrBad(pr);
      if(n !== pr){ row["Price"] = (n==="__BAD__") ? "__BAD__" : n; changed++; }
    }
    // Date
    const pd = normBlank(row["Pub Date"]);
    if(pd){
      const n = normDate(pd);
      if(n !== pd){ row["Pub Date"]=n; changed++; }
    }
    // Pages
    const pg = normBlank(row["Pages"]);
    if(pg){
      const n = normPages(pg);
      if(n !== pg){ row["Pages"]=n; changed++; }
    }
    // Currency: 비어있으면 발행사 기준으로 채움(파일 기반 상수)
    const cu = normBlank(row["Currency"]);
    if(!cu){
      const pub = normBlank(row["Publisher"]);
      if(pub==="Elsevier" || pub==="Wiley"){ row["Currency"]="USD"; changed++; }
      if(pub==="Springer"){ row["Currency"]="EUR"; changed++; }
    }
  }
  saveJSON(LS_DB, DB);
  log("자동 수정", {changed});
  sortDB();
  renderAll();
}

/* ===========================
 *  8) 렌더
 *  =========================== */
const hdrEl = document.getElementById("hdr");
const bodyEl = document.getElementById("body");
const cardsEl = document.getElementById("cards");

function renderHeader(){
  hdrEl.innerHTML = "";
  for(const col of LOCK_STANDARD_COLS){
    const th = document.createElement("th");
    th.textContent = col;
    th.className = colClass(col);
    hdrEl.appendChild(th);
  }
}
function colClass(col){
  if(col==="Publisher") return "colPub";
  if(col==="Title") return "colTitle";
  if(col==="Sub Title") return "colSub";
  if(col==="KOR_TITLE" || col==="KOR_SUBTITLE") return "colKor";
  if(col==="ISBN") return "colISBN";
  if(col==="Price") return "colPrice";
  if(col==="Currency") return "colCur";
  if(col==="Pub Date") return "colDate";
  if(col==="Pages") return "colPages";
  if(col==="_ANCHOR(file|row|id)") return "colAnchor";
  return "";
}

function renderTable(){
  renderHeader();
  bodyEl.innerHTML = "";
  for(const row of DB){
    const tr = document.createElement("tr");
    for(const col of LOCK_STANDARD_COLS){
      const td = document.createElement("td");
      td.className = colClass(col);

      const val = (row[col] !== undefined) ? row[col] : "";
      const v = fmtCell(val);

      const box = document.createElement("div");
      box.className = "gridCell";

      // 셀별 “문제 보기” 버튼(질문하지 말고, 이슈 리스트로 가게)
      const st = cellStatus(row, col);
      const btn = document.createElement("div");
      btn.className = "xbtn " + (st.hasIssue ? "on":"off");
      btn.textContent = st.hasIssue ? "!" : "✓";
      btn.title = st.title;

      btn.addEventListener("click", ()=>{
        if(st.hasIssue){
          // 해당 셀 이슈만 모달에서 필터링
          showXModal({anchorKey: row.__anchorKey, col});
        }else{
          showWModal({anchorKey: row.__anchorKey, col});
        }
      });

      const text = document.createElement("div");
      text.textContent = v;
      if(v==="(형식오류)") text.style.color = "var(--warn)";
      if(v==="(빈칸)") text.style.color = "var(--muted)";
      if(col==="_ANCHOR(file|row|id)") text.classList.add("mono");

      // Anchor는 오른쪽 끝(이미 컬럼 마지막)
      box.appendChild(btn);
      box.appendChild(text);
      td.appendChild(box);
      tr.appendChild(td);
    }
    bodyEl.appendChild(tr);
  }
}

function renderCards(){
  cardsEl.innerHTML = "";
  for(const row of DB){
    const card = document.createElement("div");
    card.className = "card";

    const top = document.createElement("div");
    top.className = "cardTop";

    const left = document.createElement("div");
    left.innerHTML = `
      <span class="pill"><b>${escapeHtml(row["Publisher"]||"")}</b></span>
      <span class="pill mono">${escapeHtml(row["_ANCHOR(file|row|id)"]||row.__anchorKey||"")}</span>
    `;

    const right = document.createElement("div");
    const st = rowStatus(row);
    right.innerHTML = `
      <span class="pill"><span class="${st.xOpen>0?'badgeBad':'badgeOk'}">X ${st.xOpen}</span></span>
      <span class="pill"><span class="${st.warn>0?'badgeWarn':'badgeOk'}">W ${st.warn}</span></span>
    `;

    top.appendChild(left);
    top.appendChild(right);

    const kv = document.createElement("div");
    kv.className = "kv";
    for(const col of LOCK_STANDARD_COLS){
      if(col==="_ANCHOR(file|row|id)") continue;
      const k = document.createElement("div");
      k.className = "k";
      k.textContent = col;
      const v = document.createElement("div");
      v.className = "v";
      v.textContent = fmtCell((row[col]!==undefined)?row[col]:"");
      if(v.textContent==="(형식오류)") v.style.color="var(--warn)";
      if(v.textContent==="(빈칸)") v.style.color="var(--muted)";
      kv.appendChild(k); kv.appendChild(v);
    }

    card.appendChild(top);
    card.appendChild(kv);
    cardsEl.appendChild(card);
  }
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
}

function rowStatus(row){
  const all = computeXandWarnings();
  const xOpen = all.XOpen.filter(it=>it.key.includes(`|${row.__anchorKey}|`)).length;
  const warn = all.W.filter(it=>it.rowId===row["_ANCHOR(file|row|id)"]).length;
  return {xOpen, warn};
}

function cellStatus(row, col){
  const all = computeXandWarnings();
  const xCell = all.XOpen.find(it => it.key.includes(`|${row.__anchorKey}|${col}|`));
  if(xCell){
    return {hasIssue:true, title:`X: ${xCell.code}`};
  }
  const wCell = all.W.find(it => it.rowId===row["_ANCHOR(file|row|id)"] && it.col===col);
  if(wCell){
    return {hasIssue:false, title:`W: ${wCell.code}`};
  }
  return {hasIssue:false, title:"PASS"};
}

function renderKpis(){
  const all = computeXandWarnings();
  document.getElementById("kpiRows").textContent = String(DB.length);
  document.getElementById("kpiXOpen").textContent = String(all.XOpen.length);
  document.getElementById("kpiWarn").textContent = String(all.W.length);
  saveJSON(LS_DB, DB);
}
function renderAll(){
  renderTable();
  renderCards();
  renderKpis();
  renderLog();
}

function copyTextToClipboard(text){
  navigator.clipboard?.writeText(text).then(()=>{
    log("복사", {len:text.length});
  }).catch(()=>{
    // fallback
    const ta = document.createElement("textarea");
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    ta.remove();
    log("복사(fallback)", {len:text.length});
  });
}

/* ===========================
 *  9) 리스트 모달 렌더 + 옵션(3버튼 + 정책변경)
 *  =========================== */
function showXModal(filter){
  renderXModal(filter);
  document.getElementById("modalXBack").style.display="flex";
}
function showWModal(filter){
  renderWModal(filter);
  document.getElementById("modalWBack").style.display="flex";
}

function renderXModal(filter){
  const listEl = document.getElementById("xList");
  listEl.innerHTML = "";
  const all = computeXandWarnings();
  let items = all.X.map((it, idx)=>({ ...it, no: idx+1 }));
  if(filter && filter.anchorKey){
    items = items.filter(it => it.key.includes(`|${filter.anchorKey}|`));
  }
  if(filter && filter.col){
    items = items.filter(it => it.col === filter.col);
  }

  // “하나도 안 뜬다” 방지: X가 0이면 이유를 UI 경고로 안내
  if(items.length===0){
    const box = document.createElement("div");
    box.className="item";
    box.innerHTML = `<div class="itemTop">
      <div class="itemMeta"><span class="pill"><b>X가 없음</b></span></div>
    </div>
    <div class="reason">현재 규칙상 X로 분류된 항목이 없다. (KOR 공란을 X로 보는 규칙은 이미 적용됨)</div>`;
    listEl.appendChild(box);
    return;
  }

  items.forEach((it)=>{
    const resolved = isResolved(it);
    const box = document.createElement("div");
    box.className = "item";

    const top = document.createElement("div");
    top.className = "itemTop";

    const meta = document.createElement("div");
    meta.className = "itemMeta";
    meta.innerHTML = `
      <span class="pill"><b>#${it.no}</b></span>
      <span class="pill"><span class="badgeBad">X</span></span>
      <span class="pill"><b>${escapeHtml(it.code)}</b></span>
      <span class="pill mono">${escapeHtml(it.rowId||"UI")}</span>
      ${it.col ? `<span class="pill"><b>${escapeHtml(it.col)}</b></span>` : ``}
      ${resolved ? `<span class="pill"><span class="badgeOk">해결됨</span></span>` : `<span class="pill"><span class="badgeBad">열림</span></span>`}
    `;

    const actions = document.createElement("div");
    actions.className = "actions";

    const b1 = document.createElement("button");
    b1.className = "btn small";
    b1.textContent = "공란 유지(해결)";
    b1.onclick = ()=>{
      setResolution(it.key, "KEEP_BLANK");
      log("X 해결", {code:it.code, rowId:it.rowId, col:it.col, by:"KEEP_BLANK"});
      renderAll(); renderXModal(filter);
    };

    const b2 = document.createElement("button");
    b2.className = "btn small";
    b2.textContent = "자동 변환(해결)";
    b2.onclick = ()=>{
      // 변환은 자동수정 버튼과 동일하게 적용
      autoFix();
      setResolution(it.key, "AUTO_CONVERT");
      log("X 해결", {code:it.code, rowId:it.rowId, col:it.col, by:"AUTO_CONVERT"});
      renderAll(); renderXModal(filter);
    };

    const b3 = document.createElement("button");
    b3.className = "btn small";
    b3.textContent = "무시(통과)";
    b3.onclick = ()=>{
      setResolution(it.key, "IGNORE");
      log("X 통과", {code:it.code, rowId:it.rowId, col:it.col, by:"IGNORE"});
      renderAll(); renderXModal(filter);
    };

    const b4 = document.createElement("button");
    b4.className = "btn small";
    b4.textContent = "정책 변경(규칙 수정)";
    b4.onclick = ()=>{
      // 사용자를 입력으로 유도하지 않고, “기본 정책 프리셋”을 적용
      // (현재는 KOR 공란을 X로 보는 정책을 고정 유지)
      log("정책 변경", {preset:"NO_INPUT_PRESET", note:"사용자 입력 유도 없음"});
      alert("정책 변경은 ‘프리셋 적용’만 지원(사용자 입력 유도 없음). 현재 KOR 공란=X 정책 유지.");
    };

    actions.appendChild(b1);
    actions.appendChild(b2);
    actions.appendChild(b3);
    actions.appendChild(b4);

    top.appendChild(meta);
    top.appendChild(actions);

    const reason = document.createElement("div");
    reason.className = "reason";
    reason.innerHTML = `
      ${escapeHtml(it.msg)}<br/>
      <span class="mono">${escapeHtml(it.meta||"")}</span><br/>
      ${escapeHtml(it.how||"")}
    `;

    box.appendChild(top);
    box.appendChild(reason);
    listEl.appendChild(box);
  });
}

function renderWModal(filter){
  const listEl = document.getElementById("wList");
  listEl.innerHTML = "";
  const all = computeXandWarnings();
  let items = all.W.map((it, idx)=>({ ...it, no: idx+1 }));
  if(filter && filter.anchorKey){
    items = items.filter(it => (it.key||"").includes(`|${filter.anchorKey}|`));
  }
  if(filter && filter.col){
    items = items.filter(it => it.col === filter.col);
  }

  if(items.length===0){
    const box = document.createElement("div");
    box.className="item";
    box.innerHTML = `<div class="itemTop">
      <div class="itemMeta"><span class="pill"><b>경고가 없음</b></span></div>
    </div>`;
    listEl.appendChild(box);
    return;
  }

  items.forEach((it)=>{
    const box = document.createElement("div");
    box.className = "item";

    const top = document.createElement("div");
    top.className = "itemTop";

    const meta = document.createElement("div");
    meta.className = "itemMeta";
    meta.innerHTML = `
      <span class="pill"><b>#${it.no}</b></span>
      <span class="pill"><span class="badgeWarn">W</span></span>
      <span class="pill"><b>${escapeHtml(it.code)}</b></span>
      ${it.rowId ? `<span class="pill mono">${escapeHtml(it.rowId)}</span>` : `<span class="pill mono">UI</span>`}
      ${it.col ? `<span class="pill"><b>${escapeHtml(it.col)}</b></span>` : ``}
    `;

    top.appendChild(meta);

    const reason = document.createElement("div");
    reason.className = "reason";
    reason.innerHTML = `
      ${escapeHtml(it.msg)}<br/>
      ${escapeHtml(it.how||"")}
    `;

    box.appendChild(top);
    box.appendChild(reason);
    listEl.appendChild(box);
  });
}

function buildXText(){
  const all = computeXandWarnings();
  const items = all.X.map((it, idx)=>({ ...it, no: idx+1, resolved:isResolved(it) }));
  if(items.length===0) return "X=0";
  return items.map(it=>{
    return `#${it.no}\t${it.type}\t${it.code}\t${it.msg}\trowId=${it.rowId}\tcol=${it.col}\tRES=${it.resolved?"Y":"N"}\tHOW=${it.how}`;
  }).join("\n");
}
function buildWText(){
  const all = computeXandWarnings();
  const items = all.W.map((it, idx)=>({ ...it, no: idx+1 }));
  if(items.length===0) return "W=0";
  return items.map(it=>{
    return `#${it.no}\t${it.type}\t${it.code}\t${it.msg}\t${it.rowId?("rowId="+it.rowId):"UI"}\tcol=${it.col||""}\tHOW=${it.how||""}`;
  }).join("\n");
}

/* ===========================
 *  10) 업로드
 *  =========================== */
async function readFileAsText(file){
  return new Promise((res, rej)=>{
    const fr = new FileReader();
    fr.onload = ()=> res(fr.result);
    fr.onerror = ()=> rej(fr.error);
    fr.readAsText(file);
  });
}

async function readAndAppendFile(file){
  const name = file.name;
  const publisher = detectPublisher(name);
  const mapping = getMappingFor(name);

  const text = await readFileAsText(file);
  const rows = parseCSV(text);
  if(rows.length < 2){
    log("업로드 실패", {file:name, reason:"no rows"});
    return;
  }
  const headers = rows[0].map(h=>normBlank(h));
  log("업로드 시작", {file:name, publisher, headers});
  log("매핑 확정", {file:name, mapping});

  let appended=0;
  for(let i=1;i<rows.length;i++){
    const rawRow = rows[i];
    if(rawRow.every(c=>normBlank(c)==="")) continue;
    const rec = makeStandardRow({
      fileName:name,
      publisher,
      headers,
      rawRow,
      rowIndex:i,
      mapping
    });
    DB.push(rec);
    appended++;
  }
  document.getElementById("kpiLast").textContent = name;
  log("업로드 완료", {file:name, appended, total:DB.length});
}

async function handleFiles(files){
  for(const f of files){
    await readAndAppendFile(f);
  }
  sortDB();
  saveJSON(LS_DB, DB);
  renderAll();
}

/* ===========================
 *  11) 탭/이벤트
 *  =========================== */
document.getElementById("fileInput").addEventListener("change", async (e)=>{
  const files = Array.from(e.target.files || []);
  if(!files.length) return;
  await handleFiles(files);
  e.target.value = "";
});

document.getElementById("btnResetDB").addEventListener("click", ()=>{
  DB = [];
  resolutions = {};
  saveJSON(LS_DB, DB);
  saveJSON(LS_RES, resolutions);
  log("DB 초기화", {});
  renderAll();
});

document.getElementById("btnClearLog").addEventListener("click", ()=>{
  logLines = [];
  saveJSON(LS_LOG, logLines);
  renderLog();
});

document.getElementById("btnResort").addEventListener("click", ()=>{
  sortDB();
  log("정렬 재적용", {by:"Pub Date ↑"});
  renderAll();
});
document.getElementById("btnRecalc").addEventListener("click", ()=>{
  log("오류 재계산", {});
  renderAll();
});

document.getElementById("btnAutoFix").addEventListener("click", ()=>{
  autoFix();
});

document.getElementById("btnShowX").addEventListener("click", ()=>{
  showXModal(null);
});
document.getElementById("btnShowW").addEventListener("click", ()=>{
  showWModal(null);
});

document.getElementById("btnCloseX").addEventListener("click", ()=>{
  document.getElementById("modalXBack").style.display="none";
});
document.getElementById("btnCloseW").addEventListener("click", ()=>{
  document.getElementById("modalWBack").style.display="none";
});
document.getElementById("modalXBack").addEventListener("click", (e)=>{
  if(e.target.id==="modalXBack") document.getElementById("modalXBack").style.display="none";
});
document.getElementById("modalWBack").addEventListener("click", (e)=>{
  if(e.target.id==="modalWBack") document.getElementById("modalWBack").style.display="none";
});

document.getElementById("btnResolveAllX").addEventListener("click", ()=>{
  const all = computeXandWarnings();
  all.X.forEach(it=>{
    // 기본 프리셋: 텍스트 입력 유도 없이 “공란 유지(해결)”로 처리
    if(!isResolved(it)) setResolution(it.key, "KEEP_BLANK");
  });
  log("X 전체 공란유지(해결)", {count: all.X.length});
  renderAll(); renderXModal(null);
});
document.getElementById("btnClearResolvedX").addEventListener("click", ()=>{
  resolutions = {};
  saveJSON(LS_RES, resolutions);
  log("X 해결표시 초기화", {});
  renderAll(); renderXModal(null);
});

document.getElementById("btnCopyX").addEventListener("click", ()=> copyTextToClipboard(buildXText()));
document.getElementById("btnCopyW").addEventListener("click", ()=> copyTextToClipboard(buildWText()));
document.getElementById("btnCopyXIn").addEventListener("click", ()=> copyTextToClipboard(buildXText()));
document.getElementById("btnCopyWIn").addEventListener("click", ()=> copyTextToClipboard(buildWText()));
document.getElementById("btnCopyLog").addEventListener("click", ()=> copyTextToClipboard(logLines.join("\n")));

document.getElementById("tabTable").addEventListener("click", ()=>{
  document.getElementById("tabTable").classList.add("on");
  document.getElementById("tabLog").classList.remove("on");
  document.getElementById("viewTable").style.display="";
  document.getElementById("viewLog").style.display="none";
});
document.getElementById("tabLog").addEventListener("click", ()=>{
  document.getElementById("tabLog").classList.add("on");
  document.getElementById("tabTable").classList.remove("on");
  document.getElementById("viewLog").style.display="";
  document.getElementById("viewTable").style.display="none";
});

/* ===========================
 *  12) 초기 표시
 *  =========================== */
renderAll();
renderLog();
</script>
</body>
</html>
