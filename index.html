<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>27번 도구 – 엑셀 업로드 (셀 X 방식 안정화 버전)</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
button { padding: 6px 10px; margin: 2px; cursor: pointer; }
table { border-collapse: collapse; width: 100%; font-size: 13px; }
th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
th { background: #f5f5f5; }
.cell-x { color: red; font-weight: bold; cursor: pointer; }
.cell-disabled { background: #ffe5e5; color: #999; text-decoration: line-through; }
.topbar { margin-bottom: 10px; }
.log { background:#111; color:#0f0; padding:10px; font-size:12px; height:120px; overflow:auto; }
.small { font-size:12px; color:#666; }
</style>
</head>
<body>

<h2>27번 도구 – 엑셀 업로드 (셀 X 안정화 버전)</h2>

<div class="topbar">
<input type="file" id="fileInput" accept=".xlsx,.xls" />
<button onclick="uploadFile()">업로드(추가/합치기)</button>
<button onclick="resetDB()">DB 초기화</button>
</div>

<div class="small">셀마다 X만 존재합니다. PASS 없음. 행 X 없음. 구조 안정화 전용.</div>

<table id="dataTable">
<thead>
<tr>
<th>Publisher</th>
<th>KOR_TITLE</th>
<th>Title</th>
<th>Sub Title</th>
<th>ISBN</th>
<th>Price</th>
<th>Currency</th>
<th>Pub Date</th>
<th>Pages</th>
</tr>
</thead>
<tbody></tbody>
</table>

<h3>로그</h3>
<div id="log" class="log"></div>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script>
let DB = JSON.parse(localStorage.getItem('DB')||'[]');
let CELL_X = JSON.parse(localStorage.getItem('CELL_X')||'{}');

function log(msg){
 const el=document.getElementById('log');
 const t=new Date().toLocaleTimeString();
 el.innerHTML += `[${t}] ${msg}<br>`;
 el.scrollTop = el.scrollHeight;
}

function save(){
 localStorage.setItem('DB',JSON.stringify(DB));
 localStorage.setItem('CELL_X',JSON.stringify(CELL_X));
}

function resetDB(){
 if(!confirm('DB 초기화?')) return;
 DB=[]; CELL_X={}; save(); render(); log('DB 초기화');
}

function uploadFile(){
 const f=document.getElementById('fileInput').files[0];
 if(!f){alert('파일 선택');return;}
 const reader=new FileReader();
 reader.onload=e=>{
  const wb=XLSX.read(e.target.result,{type:'binary'});
  const ws=wb.Sheets[wb.SheetNames[0]];
  const data=XLSX.utils.sheet_to_json(ws);
  DB=DB.concat(data);
  save(); render(); log('업로드 완료 '+data.length+'건');
 };
 reader.readAsBinaryString(f);
}

function cellKey(r,c){return r+'_'+c;}

function toggleX(r,c){
 const k=cellKey(r,c);
 CELL_X[k]=!CELL_X[k];
 save(); render();
}

function render(){
 const tb=document.querySelector('#dataTable tbody');
 tb.innerHTML='';
 DB.forEach((row,r)=>{
  const tr=document.createElement('tr');
  Object.values(row).slice(0,9).forEach((val,c)=>{
   const td=document.createElement('td');
   const k=cellKey(r,c);
   const span=document.createElement('span');
   span.textContent = val||'';
   if(CELL_X[k]) span.className='cell-disabled';
   const x=document.createElement('span');
   x.textContent=' X';
   x.className='cell-x';
   x.onclick=()=>toggleX(r,c);
   td.appendChild(span);
   td.appendChild(x);
   tr.appendChild(td);
  });
  tb.appendChild(tr);
 });
}

render();
log('페이지 로드');
</script>
</body>
</html>
